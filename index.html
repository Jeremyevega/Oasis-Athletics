<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="login">
    <h2>Client Login</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="signInBtn">Sign In</button>
    <button id="signUpBtn">Sign Up</button>
  </div>

  <div class="sidebar">
    <div class="logo-placeholder">LOGO</div>
    <nav>
      <ul>
        <li><a href="#dashboard">Dashboard</a></li>
        <li><a href="#workout">Workout Plan</a></li>
        <li><a href="#nutrition">Nutrition</a></li>
        <li><a href="#admin-panel" id="adminPanelLink" style="display:none;">Admin Panel</a></li>
        <li><a href="#" id="signOutLink">Logout</a></li>
      </ul>
    </nav>
  </div>

  <div class="main-content">
    <section id="dashboard">
      <h1>Welcome, <span id="clientName">User</span>!</h1>
      <p>Select a tab to view your plan.</p>
    </section>

    <section id="workout">
      <h2>Your Workout Plan</h2>
      <div id="clientWorkoutOutput"></div>
    </section>

    <section id="nutrition">
      <h2>Your Meal Plan</h2>
      <div id="clientMealOutput"></div>
      <p id="clientMacroTotal"></p>
    </section>

    <section id="admin-panel" style="display:none;">
      <h2>Admin Panel</h2>
      <label for="clientSelect">Select Client:</label>
      <select id="clientSelect">
        <option disabled selected>Choose a client</option>
      </select>

      <h3>Assign Workouts by Day</h3>
      <label for="workoutDay">Day:</label>
      <select id="workoutDay">
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
        <option value="Sunday">Sunday</option>
      </select>
      <div id="exerciseList"></div>
      <button id="addWorkoutBtn">+ Add Exercise</button>

      <h3>Assign Meal Plan</h3>
      <div id="mealList"></div>
      <button id="addMealBtn">+ Add Meal</button>
      <p><strong>Total:</strong> <span id="dailyTotal">Calories: 0 | Protein: 0g | Carbs: 0g | Fats: 0g</span></p>

      <button id="previewBtn">üîç Preview</button>
    </section>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBWzRFnpvX10kF7eCBezX3vY9MBVXlpV6g",
      authDomain: "mytrainingapp-3a352.firebaseapp.com",
      projectId: "mytrainingapp-3a352",
      storageBucket: "mytrainingapp-3a352.appspot.com",
      messagingSenderId: "802120004680",
      appId: "1:802120004680:web:ac9496211c8d3de7f9147d"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginDiv = document.getElementById('login');
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');
    const signInBtn = document.getElementById('signInBtn');
    const signUpBtn = document.getElementById('signUpBtn');
    const signOutLink = document.getElementById('signOutLink');
    const adminPanelLink = document.getElementById('adminPanelLink');
    const clientSelect = document.getElementById('clientSelect');
    const clientNameSpan = document.getElementById('clientName');
    const workoutOutput = document.getElementById('clientWorkoutOutput');
    const mealOutput = document.getElementById('clientMealOutput');
    const macroTotal = document.getElementById('clientMacroTotal');

    const exerciseList = document.getElementById('exerciseList');
    const addWorkoutBtn = document.getElementById('addWorkoutBtn');
    const mealList = document.getElementById('mealList');
    const addMealBtn = document.getElementById('addMealBtn');
    const workoutDay = document.getElementById('workoutDay');
    const dailyTotal = document.getElementById('dailyTotal');

    let currentUserId = null;

    auth.onAuthStateChanged(user => {
      if (!user) return location.reload();
      currentUserId = user.uid;
      loginDiv.style.display = 'none';
      sidebar.style.display = 'block';
      mainContent.style.display = 'block';
      clientNameSpan.textContent = user.email.split('@')[0];

      if (user.email === 'jeremyevega@icloud.com') {
        adminPanelLink.style.display = 'block';
        document.getElementById('admin-panel').style.display = 'block';
        db.collection('clients').get().then(snapshot => {
          snapshot.forEach(doc => {
            const opt = document.createElement('option');
            opt.value = doc.id;
            opt.textContent = doc.data().email;
            clientSelect.appendChild(opt);
          });
        });
      } else {
        db.collection('clients').doc(currentUserId).get().then(doc => {
          const data = doc.data();
          displayClientWorkout(data.workout);
          displayClientMeals(data.meals);
        });
      }
    });

    function displayClientWorkout(workout = []) {
      const days = {};
      workoutOutput.innerHTML = '';
      workout.forEach(item => {
        if (!days[item.day]) days[item.day] = [];
        days[item.day].push(item);
      });
      for (const day in days) {
        const block = document.createElement('div');
        block.innerHTML = `<h3>${day}</h3>`;
        days[day].forEach(ex => {
          block.innerHTML += `<p><strong>${ex.name}</strong> ‚Äî ${ex.setsReps}, ${ex.weight}, ${ex.rest}</p>`;
        });
        workoutOutput.appendChild(block);
      }
    }

    function displayClientMeals(meals = []) {
      mealOutput.innerHTML = '';
      let cal = 0, p = 0, c = 0, f = 0;
      meals.forEach(meal => {
        cal += meal.calories || 0;
        p += meal.protein || 0;
        c += meal.carbs || 0;
        f += meal.fats || 0;
        mealOutput.innerHTML += `<p><strong>${meal.name}</strong> ‚Äî ${meal.calories} cal, P:${meal.protein}g C:${meal.carbs}g F:${meal.fats}g</p>`;
      });
      macroTotal.textContent = `Total: ${cal} cal | Protein: ${p}g | Carbs: ${c}g | Fats: ${f}g`;
    }

    signInBtn.onclick = () => {
      auth.signInWithEmailAndPassword(
        document.getElementById('email').value,
        document.getElementById('password').value
      ).catch(e => alert(e.message));
    };

    signUpBtn.onclick = () => {
      auth.createUserWithEmailAndPassword(
        document.getElementById('email').value,
        document.getElementById('password').value
      ).then(cred => {
        return db.collection('clients').doc(cred.user.uid).set({
          email: cred.user.email,
          workout: [],
          meals: []
        });
      }).catch(e => alert(e.message));
    };

    signOutLink.onclick = () => auth.signOut();

    addWorkoutBtn.onclick = () => {
      const container = document.createElement('div');
      const name = document.createElement('input');
      const setsReps = document.createElement('input');
      const weight = document.createElement('input');
      const rest = document.createElement('input');

      name.placeholder = 'Name';
      setsReps.placeholder = 'Sets x Reps';
      weight.placeholder = 'Weight';
      rest.placeholder = 'Rest';

      [name, setsReps, weight, rest].forEach(el => {
        el.style.display = 'block';
        el.addEventListener('input', saveWorkouts);
        container.appendChild(el);
      });
      container.dataset.day = workoutDay.value;
      exerciseList.appendChild(container);
      saveWorkouts();
    };

    function saveWorkouts() {
      const clientId = clientSelect.value;
      if (!clientId) return;
      const all = exerciseList.querySelectorAll('div');
      const arr = Array.from(all).map(div => {
        const inputs = div.querySelectorAll('input');
        return {
          day: div.dataset.day,
          name: inputs[0].value,
          setsReps: inputs[1].value,
          weight: inputs[2].value,
          rest: inputs[3].value
        };
      });
      db.collection('clients').doc(clientId).update({ workout: arr });
    }

    addMealBtn.onclick = () => {
      const container = document.createElement('div');
      const name = document.createElement('input');
      const cal = document.createElement('input');
      const p = document.createElement('input');
      const c = document.createElement('input');
      const f = document.createElement('input');
      name.placeholder = 'Meal';
      cal.placeholder = 'Calories';
      p.placeholder = 'Protein';
      c.placeholder = 'Carbs';
      f.placeholder = 'Fats';
      [name, cal, p, c, f].forEach(input => {
        input.style.display = 'block';
        input.addEventListener('input', saveMeals);
        container.appendChild(input);
      });
      mealList.appendChild(container);
      saveMeals();
    };

    function saveMeals() {
      const clientId = clientSelect.value;
      if (!clientId) return;
      const blocks = mealList.querySelectorAll('div');
      const meals = [], totals = { cal: 0, p: 0, c: 0, f: 0 };
      blocks.forEach(div => {
        const i = div.querySelectorAll('input');
        const meal = {
          name: i[0].value,
          calories: parseInt(i[1].value) || 0,
          protein: parseInt(i[2].value) || 0,
          carbs: parseInt(i[3].value) || 0,
          fats: parseInt(i[4].value) || 0
        };
        totals.cal += meal.calories;
        totals.p += meal.protein;
        totals.c += meal.carbs;
        totals.f += meal.fats;
        meals.push(meal);
      });
      dailyTotal.textContent = `Calories: ${totals.cal} | Protein: ${totals.p}g | Carbs: ${totals.c}g | Fats: ${totals.f}g`;
      db.collection('clients').doc(clientId).update({ meals });
    }

    clientSelect.onchange = () => {
      const id = clientSelect.value;
      if (!id) return;
      db.collection('clients').doc(id).get().then(doc => {
        const data = doc.data();
        exerciseList.innerHTML = '';
        data.workout?.forEach(ex => {
          const container = document.createElement('div');
          container.dataset.day = ex.day || 'Unassigned';
          const name = document.createElement('input');
          name.value = ex.name || '';
          const setsReps = document.createElement('input');
          setsReps.value = ex.setsReps || '';
          const weight = document.createElement('input');
          weight.value = ex.weight || '';
          const rest = document.createElement('input');
          rest.value = ex.rest || '';
          [name, setsReps, weight, rest].forEach(input => {
            input.style.display = 'block';
            input.addEventListener('input', saveWorkouts);
            container.appendChild(input);
          });
          exerciseList.appendChild(container);
        });
        mealList.innerHTML = '';
        data.meals?.forEach(meal => {
          const container = document.createElement('div');
          const name = document.createElement('input');
          name.value = meal.name || '';
          const cal = document.createElement('input');
          cal.value = meal.calories || 0;
          const p = document.createElement('input');
          p.value = meal.protein || 0;
          const c = document.createElement('input');
          c.value = meal.carbs || 0;
          const f = document.createElement('input');
          f.value = meal.fats || 0;
          [name, cal, p, c, f].forEach(input => {
            input.style.display = 'block';
            input.addEventListener('input', saveMeals);
            container.appendChild(input);
          });
          mealList.appendChild(container);
        });
        saveWorkouts();
        saveMeals();
      });
    };

    document.getElementById('previewBtn').onclick = () => {
      const clientId = clientSelect.value;
      if (!clientId) return alert('Select a client first');
      window.open(`preview.html?id=${clientId}`, '_blank');
    };
  </script>
</body>
</html>
